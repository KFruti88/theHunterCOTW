<div id="wp-custom-wrapper">
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

    <div class="cotw-dashboard">
        <header class="tracker-header">
            <div class="header-top">
                <div class="flex flex-col items-start text-left">
                    <h1>COTW: Master Tracker</h1>
                    <div id="twitch-status" class="twitch-status">Twitch: Checking Status...</div>
                </div>
                <div class="header-controls">
                    <span id="version-tag" class="text-[9px] opacity-30 mr-2">v2.5.2</span>
                    <button id="sync-btn" onclick="syncWithPSN()" class="sync-button">üîÑ Sync Profile</button>
                </div>
            </div>
            <p id="stats-summary" class="status-text">Registry: Booting...</p>
            <div class="psn-card-container">
                <a href="https://psnprofiles.com/Werewolf3788" target="_blank">
                    <img src="https://card.psnprofiles.com/1/Werewolf3788.png" border="0" alt="Werewolf PSN Card" class="psn-card-img">
                </a>
            </div>
        </header>

        <div class="section-title border-blue-500/50 text-blue-400">üó∫Ô∏è Tactical Reserve Map</div>
        <div id="tactical-map-container" style="width: 100%; aspect-ratio: 1/1; background: #000; border: 2px solid #2ecc71; border-radius: 12px; overflow: hidden; margin-bottom: 20px;">
            <iframe id="map-frame" src="" style="width: 100%; height: 100%; border: none; display: none; background: transparent;"></iframe>
            <div id="map-placeholder" style="display: flex; align-items: center; justify-content: center; height: 100%; color: #2ecc71; font-weight: bold; text-align: center; padding: 20px;">
                SELECT A RESERVE BELOW TO LOAD THE TACTICAL MAP
            </div>
        </div>

        <div class="section-title border-emerald-500/50 text-emerald-400 flex justify-between items-center">
            <span>üìä <span id="display-map-name">Reserve</span> Intel</span>
            <select id="map-selector" onchange="switchMap(this.value)" class="map-select-dropdown">
                <option>Loading Maps...</option>
            </select>
        </div>

        <div class="grid-container mb-8 text-left">
            <div class="mission-card-simple p-4">
                <p class="section-sub">Map Species Harvests</p>
                <div id="species-harvest-root"></div>
                <p class="section-sub mt-6">G.O. Grind</p>
                <div id="go-grind-root"></div>
            </div>
            <div class="mission-card-simple p-4 mission-scroll-container">
                <p class="section-sub" id="mission-warden-label">Reserve Missions</p>
                <div id="mission-engine-root"></div>
            </div>
        </div>

        <div class="section-title game-stats-title">üèÜ Lifetime Harvest Ranks</div>
        <div class="mission-card-simple mb-8 p-4"><div id="rank-rows-root" class="rank-grid"></div></div>

        <footer class="tracker-footer">
            <div class="footer-links">
                <a href="https://www.amazon.com/gp/goldbox?tag=todaysdealswerewolf-20" target="_blank">Today's Deals</a>
                <a href="https://www.amazon.com/s?k=fishing&tag=psngaming-20" target="_blank">Hunting Gear</a>
                <a href="https://www.amazon.com/s?k=farming&tag=psngaming-20" target="_blank">Farming Tools</a>
            </div>
            <p>Lead Dev: Werewolf3788 | Source: KFruti88 GitHub | v2.5.2</p>
        </footer>
    </div>

    <style>
        #wp-custom-wrapper { background: transparent !important; padding: 20px 0; font-family: 'Segoe UI', sans-serif; color: #fff; display: flex; justify-content: center; width: 100%; }
        .cotw-dashboard { width: 90%; max-width: 1200px; background: rgba(8, 12, 8, 0.98); border: 2px solid #2ecc71; border-radius: 16px; padding: 25px; box-sizing: border-box; }
        .tracker-header h1 { color: #2ecc71; text-transform: uppercase; font-size: 1.6rem; margin: 0; }
        .section-title { background: rgba(46, 204, 113, 0.1); padding: 10px; margin: 20px 0 10px; border-left: 6px solid #2ecc71; font-weight: 800; text-transform: uppercase; font-size: 0.8rem; }
        .game-stats-title { border-left-color: #f39c12; color: #f39c12; }
        .grid-container { display: grid; grid-template-columns: 1fr; gap: 20px; }
        @media (min-width: 900px) { .grid-container { grid-template-columns: 4fr 6fr; } }
        .map-select-dropdown { background: #000; color: #2ecc71; border: 1px solid #2ecc71; padding: 8px; border-radius: 6px; font-weight: bold; }
        .mission-row, .species-row { display: flex; justify-content: space-between; align-items: center; padding: 8px; background: rgba(0,0,0,0.3); border-radius: 8px; margin-bottom: 5px; border: 1px solid rgba(255,255,255,0.05); }
        .btn-ctrl { background: #1a2a1a; color: #2ecc71; border: 1px solid #2ecc71; width: 30px; height: 30px; cursor: pointer; border-radius: 4px; }
        .count-display { color: #2ecc71; font-weight: 800; margin: 0 10px; }
        .psn-card-img { height: 50px; margin-top: 10px; border-radius: 6px; }
        .twitch-status { font-size: 0.65rem; color: #9146ff; border: 1px solid #9146ff; padding: 2px 8px; border-radius: 4px; margin-top: 5px; display: inline-block; }
        .rank-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 10px; }
    </style>

    <script>
        const startApp = () => {
            if (typeof firebase === 'undefined') { setTimeout(startApp, 100); return; }
            
            // Initialization
            const db = firebase.firestore();
            let mapSkeleton = {};
            let activeMapId = '';

            // --- LOAD MAP DATA FROM GITHUB ---
            const loadRegistry = async () => {
                const rawUrl = `https://raw.githubusercontent.com/KFruti88/PSN/main/Skeleton/thehunter/map_data.json`;
                try {
                    const res = await fetch(rawUrl);
                    const data = await res.json();
                    mapSkeleton = data;
                    
                    const selector = document.getElementById('map-selector');
                    selector.innerHTML = '<option value="">-- Choose Reserve --</option>';
                    
                    Object.keys(data).forEach(id => {
                        const opt = document.createElement('option');
                        opt.value = id;
                        opt.text = data[id].name;
                        selector.add(opt);
                    });
                    document.getElementById('stats-summary').innerText = `Registry: ${Object.keys(data).length} Reserves Synced`;
                } catch (e) { console.error("Data Load Fail", e); }
            };

            // --- MAP SWITCHER (Logic to load the HTML file) ---
            window.switchMap = (id) => {
                if(!id) return;
                activeMapId = id;
                
                // 1. Update Tracker Text
                document.getElementById('display-map-name').innerText = mapSkeleton[id].name;
                
                // 2. Load the actual HTML Map from your GitHub Pages
                // This assumes your GitHub Pages is active at kfruti88.github.io
                const mapFrame = document.getElementById('map-frame');
                const placeholder = document.getElementById('map-placeholder');
                
                mapFrame.src = `https://kfruti88.github.io/PSN/Skeleton/thehunter/${id}.html`;
                mapFrame.style.display = "block";
                placeholder.style.display = "none";

                renderActiveMap(); // Runs your species/mission lists
            };

            const renderActiveMap = () => {
                const data = mapSkeleton[activeMapId];
                if (!data) return;
                
                // Species Render
                document.getElementById('species-harvest-root').innerHTML = (data.species || []).map(s => `
                    <div class="species-row">
                        <span style="font-size: 10px;">CL ${s.class} <strong>${s.name}</strong></span>
                        <div class="flex items-center">
                            <button class="btn-ctrl">-</button>
                            <span class="count-display">0</span>
                            <button class="btn-ctrl">+</button>
                        </div>
                    </div>
                `).join('');
                
                // Missions Render
                document.getElementById('mission-engine-root').innerHTML = (data.missions || []).map(group => `
                    <div style="font-size: 0.6rem; color: #2ecc71; margin-top: 10px; font-weight: bold;">${group.group}</div>
                    ${group.items.map(m => `
                        <div class="mission-row">
                            <span style="font-size: 10px;">${m.name}</span>
                            <span class="count-display">0/${m.target}</span>
                        </div>
                    `).join('')}
                `).join('');
            };

            loadRegistry();
        };

        window.onload = startApp;
    </script>
</div>
