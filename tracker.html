<div id="wp-custom-wrapper">
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <div class="cotw-dashboard">
        <header class="tracker-header">
            <h1>COTW: Master Tracker</h1>
            <p id="stats-summary" class="status-text">Registry: Connecting to GitHub...</p>
        </header>

        <div class="section-title text-blue-400">üó∫Ô∏è Tactical Reserve Map</div>
        <div id="map-viewport" class="map-viewport">
            <iframe id="map-frame" src="" class="map-iframe"></iframe>
            <div id="map-loader" class="map-loader-overlay">
                <p>INITIALIZING SKELETON ENGINE... SELECT RESERVE BELOW</p>
            </div>
        </div>

        <div class="section-title text-emerald-400 flex justify-between">
            <span>üìä <span id="display-map-name">Reserve</span> Intel</span>
            <select id="map-selector" class="map-select-dropdown">
                <option>Loading...</option>
            </select>
        </div>

        <div class="grid-container">
            <div class="mission-card-simple p-4">
                <p class="section-sub">Map Species</p>
                <div id="species-harvest-root"></div>
            </div>
            <div class="mission-card-simple p-4 mission-scroll-container">
                <p class="section-sub">Reserve Missions</p>
                <div id="mission-engine-root"></div>
            </div>
        </div>
    </div>

    <style>
        #wp-custom-wrapper { background: transparent; padding: 20px 0; color: #fff; display: flex; justify-content: center; font-family: sans-serif; }
        .cotw-dashboard { width: 90%; max-width: 1200px; background: rgba(10, 15, 10, 0.95); border: 2px solid #2ecc71; border-radius: 15px; padding: 20px; box-sizing: border-box; }
        
        /* The "Main Screen" Viewport */
        .map-viewport { position: relative; width: 100%; aspect-ratio: 16/9; background: #000; border: 1px solid #2ecc71; border-radius: 8px; overflow: hidden; }
        .map-iframe { width: 100%; height: 100%; border: none; display: none; }
        .map-loader-overlay { display: flex; align-items: center; justify-content: center; height: 100%; color: #2ecc71; font-weight: bold; }

        .section-title { background: rgba(46, 204, 113, 0.1); padding: 10px; margin: 20px 0 10px; border-left: 5px solid #2ecc71; text-transform: uppercase; font-size: 0.8rem; }
        .grid-container { display: grid; grid-template-columns: 1fr; gap: 20px; }
        @media (min-width: 900px) { .grid-container { grid-template-columns: 4fr 6fr; } }
        
        .map-select-dropdown { background: #000; color: #2ecc71; border: 1px solid #2ecc71; border-radius: 5px; padding: 5px; }
        .species-row { display: flex; justify-content: space-between; padding: 8px; background: rgba(255,255,255,0.05); margin-bottom: 5px; border-radius: 5px; font-size: 0.8rem; }

        @media (max-width: 768px) {
            .map-viewport { aspect-ratio: 1/1 !important; } /* Mobile 1:1 Requirement */
        }
    </style>

    <script type="module">
        const GITHUB_BASE = "https://kfruti88.github.io/PSN/Skeleton/thehunter/";
        const REGISTRY_URL = "https://raw.githubusercontent.com/KFruti88/PSN/main/Skeleton/thehunter/map_data.json";

        async function init() {
            try {
                const response = await fetch(REGISTRY_URL);
                const maps = await response.json();
                
                const selector = document.getElementById('map-selector');
                selector.innerHTML = '<option value="">-- SELECT RESERVE --</option>';
                
                Object.keys(maps).forEach(id => {
                    const opt = document.createElement('option');
                    opt.value = id;
                    opt.text = maps[id].name;
                    selector.add(opt);
                });

                selector.addEventListener('change', (e) => switchMap(e.target.value, maps));
                document.getElementById('stats-summary').innerText = `Registry Synced: ${Object.keys(maps).length} Reserves`;
            } catch (err) {
                console.error("Failed to load map registry:", err);
            }
        }

        function switchMap(id, maps) {
            if (!id) return;
            const frame = document.getElementById('map-frame');
            const loader = document.getElementById('map-loader');
            
            document.getElementById('display-map-name').innerText = maps[id].name;
            
            // Swap interchangeable map on the main screen
            frame.src = `${GITHUB_BASE}${id}.html`;
            frame.style.display = "block";
            loader.style.display = "none";
            
            renderSpecies(maps[id].species);
        }

        function renderSpecies(species) {
            const root = document.getElementById('species-harvest-root');
            root.innerHTML = (species || []).map(s => `
                <div class="species-row">
                    <span>CL ${s.class} <strong>${s.name}</strong></span>
                    <span>Count: 0</span>
                </div>
            `).join('');
        }

        window.onload = init;
    </script>
</div>
